<html>

<head>
    <script>
        var headerBidTag0 = '/19968336/header-bid-tag-0';
        var rightDivId = 'div-gpt-ad-1438287399331-0';

        var rightSlotSizes = [[300, 250], [300,600]];
        //var rightSlotSizes = [300, 250];

        var headerBidTag1 = '/19968336/header-bid-tag-1';
        var topDivId = 'div-gpt-ad-1438287399331-1'

        var topSlotSizes = [[728, 90], [970, 90]];

        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que  || [];
        var PREBID_TIMEOUT = 3000;

        pbjs.useSecureLoad = true;

        var date = new Date().getTime();


        function initAdserver() {
            if (!pbjs.initAdserverSet) {
                //load GPT library here

                (function () {
                    var gads = document.createElement('script');
                    gads.async = true;
                    gads.type = 'text/javascript';
                    var useSSL = 'https:' == document.location.protocol;
                    gads.src = (useSSL ? 'https:' : 'http:') +
                            '//www.googletagservices.com/tag/js/gpt.js';
                    var node = document.getElementsByTagName('script')[0];
                    node.parentNode.insertBefore(gads, node);
                })();

            }
            pbjs.initAdserverSet = true;


        }
        ;
        // Load GPT when timeout is reached.
        setTimeout(initAdserver, PREBID_TIMEOUT);
        //pbjs.ading = true;
        pbjs.que.push(function () {

          // pbjs.setConfig({ enableSendAllBids: true });

            var A9Adaptor = function A9Adaptor() {
                return {
                    callBids: function (p) {
                        pbjs.loadScript('https://c.amazon-adsystem.com/aax2/amzn_ads.js', function () {
                            amznads.getAdsCallback(p.bids[0].params.aId, function () {
                                //indicate bids are back here:
                                pbjs.bidsAvailableForAdapter('amazon');
                            });
                        });
                    }
                };
            };
           //pbjs.ading = true;

            //pbjs.onEvent('bidWon', logWinningBid, '/19968336/header-bid-tag-0');
            pbjs.onEvent('bidWon', function(data){
                console.log('winner!');
                console.log(data);
                //console.log(f);

            });

            pbjs.offEvent('bidWon');
            pbjs.registerBidAdapter(A9Adaptor, 'amazon');


            var adUnit1 = {
                code: headerBidTag0,
                //code: rightDivId,
                sizes: rightSlotSizes,
                bids: [
                  {
                      bidder: 'appnexus',
                      params: {
                          placementId: '5626309'
                      }
                  },
                  {
                    bidder: 'sekindo',
                      params: {
                        spaceId: 14071 	// REQUIRED int. To get one, contact http://www.sekindo.com
                      }
                  },
                  {
                      bidder: 'indexExchange',
                      params: {
                        id: "1",
                        siteID: 999990
                      }
                  },
                  {
                      bidder: 'sovrn',
                      params: {
                          tagid: "315045"
                      }
                  }
                ]
            };

            //can add a single ad unit
            //pbjs.addAdUnit(adUnit1);

            var adUnit2 = {
                code: headerBidTag1,
                //code : topDivId,
                sizes: [[300, 250], [300,600]],
                bids: [
                  {
                    bidder: 'appnexus',
                    params: {
                        placementId : '4799418', //''6518787',
                    }
                  }
                ]
            };

            var adUnit7 = {
                code: '/19968336/header-bid-tag-7',
                //code : topDivId,
                sizes: [[300, 250], [300,600]],
                bids: [{
                    bidder: 'appnexus',
                    params: {
                        placementId : '949941', //''6518787',
                    }
                }]
            };

            var adUnit8 = {
                code: '/19968336/header-bid-tag-8',
                //code : topDivId,
                sizes: [[300, 250], [300,600]],
                bids: [{
                    bidder: 'appnexus',
                    params: {
                        placementId : '949941', //''6518787',
                    }
                }]
            };

            var adUnit9 = {
                code: '/19968336/header-bid-tag-9',
                //code : topDivId,
                sizes: [[300, 250], [300,600]],
                bids: [{
                    bidder: 'appnexus',
                    params: {
                        placementId : '949941', //''6518787',
                    }
                }]
            };

            var adUnit10 = {
                code: '/19968336/header-bid-tag-10',
                //code : topDivId,
                sizes: [[300, 250], [300,600]],
                bids: [
                  {
                      bidder: 'sonobi',
                      params: {
                        ad_unit: '/7780971/sparks_prebid_MR',
                        dom_id: 'div-gpt-ad-1462372786781-1'
                      }
                  }
                ]
            };

            var adUnit11 = {
              code: '/19968336/header-bid-tag-11',
              sizes: [[300, 250], [300,600]],
              bids: [
                {
                  bidder: 'sovrn',
                  params: {
                    tagid: "315045"
                  }
                }
              ]
            };

            var adUnit12 = {
                code: '/19968336/header-bid-tag-12',
                sizes: [[300, 250], [300,600]],
                bids: [
                  {
                    bidder: 'springserve',
                    params: {
                      impId: 1234,
                      supplyPartnerId: 1,
                      test: true // only include when testing
                    }
                  }
                ]
            };

            var adUnit13 = {
                code: '/19968336/header-bid-tag-13',
                sizes: [[300, 250], [300,600]],
                bids: [
                  {
                      bidder: 'triplelift',
                       params: {
                           inventoryCode: 'headerbidding_placement'
                       }
                  }
              ]
            };

            var adUnit14 = {
                code: '/19968336/header-bid-tag-14',
                sizes: [[300, 250], [300,600]],
                bids: [
                  {
                    bidder: 'yieldbot',
                    params: {
                      pub: 'f82d',
                      name: 'mobile_lb'
                  }
                }
              ]
            };

            var adUnit16 = {
                code: '/19968336/header-bid-tag-16',
                sizes: [[300, 250], [300,600]],
                bids: [
                  {
                    bidder: 'brightcom',
                    params: {
                        tagId: 16577 // Tag ID supplied by Brightcom - brightcom.com
                    }
                }
              ]
            };

            pbjs.addAdUnits([adUnit2, adUnit1, adUnit16, adUnit14, adUnit13, adUnit12]);


            pbjs.bidderSettings =
            {
              sekindo : {
                bidCpmAdjustment: function (bidCpm) {
                  if(bidCpm === 0){
                    return 0;
                  }
                  return 10.00;
                },
                alwaysUseBid: false,
                adserverTargeting: [
                  {
                    key: "hb_bidder",
                    val: function (bidResponse) {
                      return bidResponse.bidderCode;
                    }
                  }, {
                    key: "hb_adid",
                    val: function (bidResponse) {
                      return bidResponse.adId;
                    }
                  },
                  {
                    key: "hb_pb",
                    val: function (bidResponse) {
                      //hard code to 5 - so we show ad
                      return bidResponse.pbMg;
                      //return  (Math.floor(Math.min(bidResponse.cpm,40) * 40) / 40).toFixed(2);
                    }
                  },
                  {
                    key: "hb_size",
                    val: function (bidResponse) {
                      return bidResponse.size;
                    }
                  },
                  {
                    key: "always_send",
                    val: function (bidResponse) {
                      return bidResponse.size;
                    }
                  },
                  {
                    key: "helloworld",
                    val: function (bidResponse) {
                      return "wow22..";
                    }
                  }
                ]
              },
              rubicon: {
                alwaysUseBid: false,
                adserverTargeting: [
                  {
                    key: "hb_bidder",
                    val: function (bidResponse) {
                      return bidResponse.bidderCode;
                    }
                  },
                  {
                    key: "hb_adid",
                    val: function (bidResponse) {
                      return bidResponse.adId;
                    }
                  },
                  {
                    key: "hb_pb",
                    val: function (bidResponse) {
                      //change default here
                      return '10.00';
                      //return bidResponse.pbMg;
                    }
                  },
                  {
                    key: "hb_size",
                    val: function (bidResponse) {
                      return bidResponse.size;

                    }
                  },
                  {
                    key: "always_send_2",
                    val: function (bidResponse) {
                      return bidResponse.size;

                    }
                  }
                ]
              },
              standard: {
                  adserverTargeting: [{
                    key: "hb_bidder",
                    val: function (bidResponse) {
                      return bidResponse.bidderCode;
                    }
                  }, {
                    key: "hb_adid",
                    val: function (bidResponse) {
                      return bidResponse.adId;
                    }
                  }, {
                    key: "hb_pb",
                    val: function (bidResponse) {
                      //change default here
                      //return '10.00';
                      return bidResponse.pbMg;
                    }
                  }, {
                    key: "hb_size",
                    val: function (bidResponse) {
                      return bidResponse.size;

                    }
                  }
                  ,
                  {
                    key: "foobar",
                    val: function (bidResponse) {
                      return bidResponse.size;

                    }
                  },
                  {
                    key: "helloworld",
                    val: function (bidResponse) {
                      return "wow..";
                    }

                  }
                ]

              }
            };

            setTimeout(function(){
              console.log('requesting bids!');
              pbjs.requestBids({

                  /* The bidsBack function will be called when either timeout is
                   reached, or when all bids come back, whichever happens sooner.
                   */
                  bidsBackHandler: function (bidResponses) {
                      console.log(bidResponses);
                      console.log(pbjs.getBidResponses());
                      console.log('');
                      console.log('//////////////////////////////////////////////////');
                      var bidAvailable = [];
                      var bidEmptyError = [];

                      Object.keys(bidResponses).forEach(function (key) {
                          bidResponses[key].bids.forEach(function (bid) {
                              if (bid.statusMessage === 'Bid available') {
                                  bidAvailable.push(bid.bidder);
                              }
                              if (bid.statusMessage === 'Bid returned empty or error response') {
                                  bidEmptyError.push(bid.bidder)
                              }
                          });
                      });
                      console.log('available: ', bidAvailable);
                      console.log('empty or error: ', bidEmptyError);
                      console.log('//////////////////////////////////////////////////');
                      console.log('');

                      var currentTime = new Date().getTime();
                      console.log('TIME for callback ===== ' + (currentTime - date));

                      initAdserver();
                      //pbjs.sendAnalyticsData();
                  },

                  timeout : PREBID_TIMEOUT
              });


            }, 500);

        });

        (function () {
            var d = document, pbs = d.createElement("script"), pro = d.location.protocal;
            pbs.type = "text/javascript";
            //pbs.src = 'http://10.17.20.67:9999/build/dev/prebid.js'
            pbs.src = '/build/dev/prebid.js';
            //pbs.src = 'http://acdn.adnxs.com/prebid/not-for-prod/prebid.js';
            var target = document.getElementsByTagName("head")[0];
            target.insertBefore(pbs, target.firstChild);
        })();

        //prbEl.src = 'http://cdn.adnxs.com/tag/v/prebid/2.1.1/prebid.min.js';


        /*
         googletag.cmd.push(function() {
         googletag.pubads().setTargeting('amtest2', ["a728x90p14", "vp1"])
         });
         */

    </script>


    <script>
        var globalslot = null;
        var logWinningBid = function logWinningBid() {
            console.log('bidWon: ', arguments);
            pbjs.offEvent('bidWon', logWinningBid, '/19968336/header-bid-tag-0');
        };
        googletag.cmd.push(function () {
            console.log('setting targeting');

            /*globalslot = googletag.defineSlot('/19968336/header-bid-tag-0', rightSlotSizes, 'div-1').addService(googletag.pubads()).setTargeting('pos', '728x90_1');

            var slot2 = googletag.defineSlot('/19968336/header-bid-tag-0', [[300,250]], 'div-2').addService(googletag.pubads()).setTargeting('pos', '300x250_1');*/


            globalslot = googletag.defineSlot('/19968336/header-bid-tag-0', rightSlotSizes, 'div-1').setTargeting('specialkey', ['special_value','val2']).setTargeting('key5', 'val5').addService(googletag.pubads());

            var slot2 = googletag.defineSlot('/19968336/header-bid-tag-2', rightSlotSizes, 'div-2').addService(googletag.pubads());
            var slot3 = googletag.defineSlot('/19968336/header-bid-tag-3', rightSlotSizes, 'div-3').addService(googletag.pubads());
            var slot4 = googletag.defineSlot('/19968336/header-bid-tag-4', rightSlotSizes, 'div-4').addService(googletag.pubads());
            var slot5 = googletag.defineSlot('/19968336/header-bid-tag-5', rightSlotSizes, 'div-5').addService(googletag.pubads());
            var slot6 = googletag.defineSlot('/19968336/header-bid-tag-6', rightSlotSizes, 'div-6').addService(googletag.pubads());
            var slot7 = googletag.defineSlot('/19968336/header-bid-tag-7', rightSlotSizes, 'div-7').addService(googletag.pubads());
            var slot8 = googletag.defineSlot('/19968336/header-bid-tag-8', rightSlotSizes, 'div-8').addService(googletag.pubads());
            var slot9 = googletag.defineSlot('/19968336/header-bid-tag-9', rightSlotSizes, 'div-9').addService(googletag.pubads());
            var slot10 = googletag.defineSlot('/19968336/header-bid-tag-10', rightSlotSizes, 'div-10').addService(googletag.pubads());
            var slot11 = googletag.defineSlot('/19968336/header-bid-tag-11', rightSlotSizes, 'div-11').addService(googletag.pubads());
            var slot12 = googletag.defineSlot('/19968336/header-bid-tag-12', rightSlotSizes, 'div-12').addService(googletag.pubads());
            var slot13 = googletag.defineSlot('/19968336/header-bid-tag-13', rightSlotSizes, 'div-13').addService(googletag.pubads());
            var slot14 = googletag.defineSlot('/19968336/header-bid-tag-14', rightSlotSizes, 'div-14').addService(googletag.pubads());
            var slot15 = googletag.defineSlot('/19968336/header-bid-tag-15', rightSlotSizes, 'div-15').addService(googletag.pubads());
            var slot16 = googletag.defineSlot('/19968336/header-bid-tag-16', rightSlotSizes, 'div-16').addService(googletag.pubads());

            pbjs.que.push(function () {
                pbjs.setTargetingForGPTAsync();

            });

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });

        function refreshBids() {
            var currentTime = new Date().getTime();
            pbjs.que.push(function () {
                pbjs.requestBids({
                    timeout: PREBID_TIMEOUT,
                    bidsBackHandler: function () {
                        var now = new Date().getTime();
                        console.log('TIME for callback ===== ' + (now - currentTime));
                        callGPT();
                    },
                    adUnitCodes: [
                        headerBidTag0, headerBidTag1
                    ]
                });
            });
        }

        function callGPT() {
            console.log('executing inside pbjs object');
            pbjs.setTargetingForGPTAsync();
            googletag.pubads().refresh();
            console.log(pbjs.getBidResponses());
        }

    </script>
</head>
<body>

<h2>Prebid.js Test3</h2>

<!-- /19968336/pbjs-right1-300x250-300x600 -->
<div id='div-1'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-1'); });
    </script>
</div>

<div id='div-2'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-2'); });
    </script>
</div>
<div id='div-3'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-3'); });
    </script>
</div>
<div id='div-4'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-4'); });
    </script>
</div>
<div id='div-5'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-5'); });
    </script>
</div>
<div id='div-6'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-6'); });
    </script>
</div>
<div id='div-7'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-7'); });
    </script>
</div>
<div id='div-8'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-8'); });
    </script>
</div><div id='div-8'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-8'); });
    </script>
</div><div id='div-9'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-9'); });
    </script>
</div><div id='div-10'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-10'); });
    </script>
</div><div id='div-11'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-11'); });
    </script>
</div><div id='div-12'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-12'); });
    </script>
</div><div id='div-13'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-13'); });
    </script>
</div><div id='div-14'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-14'); });
    </script>
</div><div id='div-15'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-15'); });
    </script>
</div><div id='div-16'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-16'); });
    </script>
</div>


<div id='div-gpt-ad-1438287399331-0'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1438287399331-0'); });
    </script>
</div>

<div id='div-gpt-ad-1438287399331-0'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1438287399331-0'); });
    </script>
</div>
<div id='div-gpt-ad-1438287399331-0'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1438287399331-0'); });
    </script>
</div>
<div id='div-gpt-ad-1438287399331-0'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1438287399331-0'); });
    </script>
</div>


<!-- /19968336/PBJS-top-728x90-970x90 -->
<div id='div-gpt-ad-1438287399331-1'>
    <script type='text/javascript'>
        googletag.cmd.push(function() { googletag.display('div-gpt-ad-1438287399331-1'); });
    </script>
</div>

<button onclick="refreshBids()">Refresh Bids</button>


<script>

    function loadGA() {


        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                        +(i[r].q = i[r].q || []).push(arguments)
                    }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-66025807-1', 'auto');


        pbjs.que.push(function () {
            pbjs.enableAnalytics({
                provider: 'example',
                options: {
                    enableDistribution: false
                }
            });
        });
    }

  pbjs.que.push(function () {
    pbjs.enableAnalytics([
      {
        provider: 'appnexus',
        options: {
          global: 'AppNexusPrebidAnalytics'
        }
      }
    ]);
  });

</script>

</body>

</html>
