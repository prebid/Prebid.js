<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>OpsMage Prebid Test Page</title>

    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js" crossorigin="anonymous"></script>
    <script>
        window.googletag = window.googletag || { cmd: [] };
        window.gptSlot = null;

        googletag.cmd.push(function () {
            googletag.pubads().disableInitialLoad();

            // Save slot reference so we can refresh JUST this slot
            window.gptSlot = googletag.defineSlot(
                '/50536250/designcon',
                [[300, 250]],
                'div-gpt-ad-1771335974713-0'
            ).addService(googletag.pubads());

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();

            // Display once (no request yet because disableInitialLoad)
            googletag.display('div-gpt-ad-1771335974713-0');
        });

        // Helper function to verify targeting in the console
        function dumpGptTargeting(label) {
            googletag.cmd.push(function () {
                const pubads = googletag.pubads();
                const keys = pubads.getTargetingKeys();
                const pubadsMap = {};
                keys.forEach(k => { pubadsMap[k] = pubads.getTargeting(k); });

                console.log(label, 'PUBADS targeting:', pubadsMap);

                if (window.gptSlot && typeof window.gptSlot.getTargetingMap === 'function') {
                    console.log(label, 'SLOT targeting:', window.gptSlot.getTargetingMap());
                }
            });
        }
    </script>

    <script async src="build/dev/prebid.js"></script>

    <script>
        var pbjs = window.pbjs = window.pbjs || {};
        pbjs.que = pbjs.que || [];

        var PREBID_TIMEOUT = 1500;

        var adUnits = [{
            code: 'div-gpt-ad-1771335974713-0',
            mediaTypes: { banner: { sizes: [[300, 250]] } },
            bids: [{
                bidder: 'appnexus',
                params: { placementId: 1234567 }
            }]
        }];

        pbjs.que.push(function () {
            pbjs.setConfig({
                debug: true,

                consentManagement: {
                    allowAuctionWithoutConsent: true,
                    gdpr: {
                        cmpApi: 'static',
                        timeout: 0,
                        consentData: {
                            getTCData: {
                                tcString: 'CPAa+2APAa+2AAOACBENC1CoAP_AAH_AAAAAAwwxgAAAAA',
                                gdprApplies: true,
                                purpose: { consents: { 1: true, 2: true, 3: true, 4: true, 5: true } },
                                vendor: { consents: { 1: true }, legitimateInterests: { 1: true } }
                            }
                        }
                    },
                    usp: { cmpApi: 'static', timeout: 0, consentData: { getUSPData: { uspString: '1---' } } }
                },

                allowActivities: {
                    accessDevice: { rules: [{ action: 'allow' }] },
                    enrichUfpd: { rules: [{ action: 'allow' }] },
                    enrichEids: { rules: [{ action: 'allow' }] },
                    transmitTid: { rules: [{ action: 'allow' }] }
                },

                realTimeData: {
                    auctionDelay: 1000, // Prebid will wait up to 500ms for Datamage to fetch data
                    dataProviders: [{
                        name: "datamage",
                        params: {
                            api_key: '8328309832',
                            selector: 'article',
                            fetch_timeout_ms: 2500
                        }
                    }]
                }
            });

            pbjs.addAdUnits(adUnits);

            pbjs.requestBids({
                bidsBackHandler: function () {
                    // Push standard header bidding keys (like hb_pb) to GPT
                    pbjs.setTargetingForGPTAsync();

                    // Dump targeting to verify Datamage was successfully pushed via setKeyValue
                    dumpGptTargeting('[before refresh]');

                    // Refresh only our specific slot
                    googletag.cmd.push(function () {
                        if (window.gptSlot) {
                            googletag.pubads().refresh([window.gptSlot]);
                        } else {
                            // Fallback
                            googletag.pubads().refresh();
                        }
                    });
                },
                timeout: PREBID_TIMEOUT
            });
        });
    </script>
</head>

<body>
    <h2>OpsMage Prebid Test Page</h2>
    <div id="div-gpt-ad-1771335974713-0" style="width:300px; height:250px;"></div>
    <article>The tech world is currently buzzing over the highly anticipated market debut of fakeDSP, a trailblazing
        startup poised to redefine the landscape of digital signal processing. Leveraging proprietary neuromorphic
        algorithms and quantum-ready architecture, fakeDSP promises to accelerate real-time data synthesis by speeds
        previously thought impossible. With early analysts calling it a definitive disruptor in both the
        telecommunications and audio-engineering sectors, the companyâ€™s entrance signifies a major leap forward in how
        complex signals are analyzed and reconstructed in the AI era.</article>
</body>

</html>