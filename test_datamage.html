<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>OpsMage Prebid Test Page</title>

    <!-- GPT -->
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js" crossorigin="anonymous"></script>
    <script>
        window.googletag = window.googletag || { cmd: [] };
        window.gptSlot = null;

        googletag.cmd.push(function () {
            googletag.pubads().disableInitialLoad();

            // ✅ Save slot reference so we can refresh JUST this slot
            window.gptSlot = googletag.defineSlot(
                '/50536250/designcon',
                [[300, 250]],
                'div-gpt-ad-1771335974713-0'
            ).addService(googletag.pubads());

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();

            // ✅ Display once (no request yet because disableInitialLoad)
            googletag.display('div-gpt-ad-1771335974713-0');
        });

        function dumpGptTargeting(label) {
            googletag.cmd.push(function () {
                const pubads = googletag.pubads();
                const keys = pubads.getTargetingKeys();
                const pubadsMap = {};
                keys.forEach(k => { pubadsMap[k] = pubads.getTargeting(k); });

                console.log(label, 'PUBADS targeting:', pubadsMap);

                if (window.gptSlot && typeof window.gptSlot.getTargetingMap === 'function') {
                    console.log(label, 'SLOT targeting:', window.gptSlot.getTargetingMap());
                }
            });
        }
    </script>

    <!-- Prebid -->
    <script async src="build/dev/prebid.js"></script>

    <script>
        var pbjs = window.pbjs = window.pbjs || {};
        pbjs.que = pbjs.que || [];

        var PREBID_TIMEOUT = 1500;
        var DATAMAGE_WAIT_MS = 1200; // bump a bit so dm arrives more often

        var adUnits = [{
            code: 'div-gpt-ad-1771335974713-0',
            mediaTypes: { banner: { sizes: [[300, 250]] } },
            bids: [{
                bidder: 'appnexus',
                params: { placementId: 1234567 }
            }]
        }];

        function looksLikeQueryStringBlob(s) {
            // Detect "om_x=y&om_a=b" style blobs (these cause %3D and %26 in the request)
            return typeof s === 'string' && /(^|&)om_[^=]+=/.test(s);
        }

        function normalizeValues(values) {
            if (values == null) return [];
            const arr = Array.isArray(values) ? values : [values];
            return arr
                .map(v => (v == null ? '' : String(v)))
                .map(v => v.trim())
                .filter(v => v.length);
        }

        function applyDatamageToGpt(gptMap) {
            if (!gptMap || !window.googletag) return;

            googletag.cmd.push(function () {
                const pubads = googletag.pubads();

                Object.keys(gptMap).forEach(function (key) {
                    let values = gptMap[key];

                    // ✅ Guard: never allow a whole querystring to be set as a value
                    if (looksLikeQueryStringBlob(values)) {
                        console.warn('Refusing to set querystring blob as targeting value for', key, values);
                        return;
                    }

                    const outVals = normalizeValues(values);
                    if (!outVals.length) return;

                    pubads.setTargeting(key, outVals);
                });

                // Useful log
                dumpGptTargeting('[after applyDatamageToGpt]');
            });
        }

        function waitForDatamage(maxWaitMs) {
            return new Promise(function (resolve) {
                if (window.__DATAMAGE_GPT_TARGETING__) {
                    resolve(window.__DATAMAGE_GPT_TARGETING__);
                    return;
                }

                let done = false;
                function finish(val) {
                    if (done) return;
                    done = true;
                    window.removeEventListener('datamage:gptTargeting', onEvt);
                    resolve(val || null);
                }

                function onEvt(e) {
                    finish(e && e.detail);
                }

                window.addEventListener('datamage:gptTargeting', onEvt);
                setTimeout(function () { finish(null); }, maxWaitMs);
            });
        }

        pbjs.que.push(function () {
            pbjs.setConfig({
                debug: true,

                consentManagement: {
                    allowAuctionWithoutConsent: true,
                    gdpr: {
                        cmpApi: 'static',
                        timeout: 0,
                        consentData: {
                            getTCData: {
                                tcString: 'CPAa+2APAa+2AAOACBENC1CoAP_AAH_AAAAAAwwxgAAAAA',
                                gdprApplies: true,
                                purpose: { consents: { 1: true, 2: true, 3: true, 4: true, 5: true } },
                                vendor: { consents: { 1: true }, legitimateInterests: { 1: true } }
                            }
                        }
                    },
                    usp: { cmpApi: 'static', timeout: 0, consentData: { getUSPData: { uspString: '1---' } } }
                },

                allowActivities: {
                    accessDevice: { rules: [{ action: 'allow' }] },
                    enrichUfpd: { rules: [{ action: 'allow' }] },
                    enrichEids: { rules: [{ action: 'allow' }] },
                    transmitTid: { rules: [{ action: 'allow' }] }
                },

                realTimeData: {
                    auctionDelay: 500,
                    dataProviders: [{
                        name: "datamage",
                        params: {
                            api_key: '5a4a9344-5fdd-4536-9a87-712915fc76e7',
                            selector: 'article',
                            auction_timeout_ms: 0,
                            fetch_timeout_ms: 2500
                        }
                    }]
                }
            });

            pbjs.addAdUnits(adUnits);

            pbjs.requestBids({
                bidsBackHandler: async function () {
                    // HB keys (if bids)
                    pbjs.setTargetingForGPTAsync();

                    // OpsMage keys (even if no bids)
                    var dm = await waitForDatamage(DATAMAGE_WAIT_MS);
                    console.log('DATAMAGE map:', dm);
                    if (dm) applyDatamageToGpt(dm);
                    // Dump before refresh (this is the truth source)
                    dumpGptTargeting('[before refresh]');

                    // ✅ Refresh only our slot (safer + easier to inspect)
                    googletag.cmd.push(function () {
                        if (window.gptSlot) {
                            googletag.pubads().refresh([window.gptSlot]);
                        } else {
                            // fallback
                            googletag.pubads().refresh();
                        }
                    });
                },
                timeout: PREBID_TIMEOUT
            });
        });
    </script>
</head>

<body>
    <h2>OpsMage Prebid Test Page</h2>
    <div id="div-gpt-ad-1771335974713-0" style="width:300px; height:250px;"></div>
    <article>This is the content being classified.</article>
</body>

</html>