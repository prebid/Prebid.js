name: Run unit tests on all browsers
on:
  workflow_call:
    inputs:
      chunks:
        description: Number of chunks to split tests into
        required: false
        type: number
        default: 1
      build-cmd:
        description: Build command, run once
        required: false
        type: string
      test-cmd:
        description: Test command, run once per chunk
        required: true
        type: string
      timeout:
        description: Timeout on test run
        required: false
        type: number
        default: 10
    outputs:
      coverage:
        description: Artifact name for coverage results
        value: ${{ jobs.collect-coverage.outputs.coverage }}
    secrets:
      BROWSERSTACK_USER_NAME:
        description: "Browserstack user name"
      BROWSERSTACK_ACCESS_KEY:
        description: "Browserstack access key"
jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      build-cmd: ${{ inputs.build-cmd }}

  setup:
    needs: build
    name: "Setup environment"
    runs-on: ubuntu-latest
    outputs:
      browsers: ${{ steps.define.outputs.result }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name:  Restore working directory
        uses: ./.github/actions/load
        with:
          name: ${{ needs.build.outputs.built-key }}
      - name: "Define testing strategy"
        uses: actions/github-script@v8
        id: define
        with:
          script: |
            const browsers = require('./.github/workflows/browser_testing.json');
            return Object.entries(browsers).map(([name, def]) => Object.assign({name}, def))

  test-build-logic:
    needs: build
    name: "Test build logic"
    uses:
      ./.github/workflows/run-tests.yml
    with:
      built-key: ${{ needs.build.outputs.built-key }}
      test-cmd: gulp test-build-logic

  browser-tests:
    needs: [setup, build]
    name: "Browser: ${{ matrix.browser.name }}"
    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJSON(needs.setup.outputs.browsers) }}
    uses:
      ./.github/workflows/run-tests.yml
    with:
      built-key: ${{ needs.build.outputs.built-key }}
      test-cmd: ${{ inputs.test-cmd }} --browsers ${{ matrix.browser.name }} ${{ matrix.browser.coverage && '--coverage' || '--no-coverage' }}
      chunks: ${{ inputs.chunks }}
      runs-on: ${{ matrix.browser.runsOn || 'ubuntu-latest' }}
