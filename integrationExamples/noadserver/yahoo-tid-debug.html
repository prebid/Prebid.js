<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yahoo Ads - ortb2.source.tid Debug Page</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            color: #569cd6;
            border-bottom: 2px solid #569cd6;
            padding-bottom: 10px;
        }
        h2 {
            color: #4ec9b0;
            margin-top: 30px;
        }
        .issue {
            background: #3a1f1f;
            border-left: 4px solid #f48771;
            padding: 15px;
            margin: 20px 0;
        }
        .expected {
            background: #1f3a1f;
            border-left: 4px solid #4ec9b0;
            padding: 15px;
            margin: 20px 0;
        }
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            margin: 10px 5px;
        }
        button:hover {
            background: #005a9e;
        }
        .log-section {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-title {
            color: #569cd6;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }
        pre {
            margin: 5px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success { color: #4ec9b0; }
        .error { color: #f48771; }
        .warning { color: #ce9178; }
        .info { color: #9cdcfe; }
        .highlight { background: #264f78; padding: 2px 4px; }
        .code {
            background: #1e1e1e;
            border: 1px solid #3e3e42;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        #ad {
            width: 300px;
            height: 250px;
            border: 2px dashed #3e3e42;
            background: #2d2d30;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Yahoo Ads Adapter - ortb2.source.tid Debug Page</h1>
        
        <div style="background: #3a1f1f; border: 3px solid #f48771; padding: 20px; margin: 20px 0; border-radius: 4px;">
            <h2 style="color: #f48771; margin-top: 0;">üö® KEY FINDING</h2>
            <p style="font-size: 16px;"><strong>Issue:</strong> <code>bidderRequest.ortb2?.source?.tid</code> is <span class="error">undefined</span> in BOTH cases:</p>
            <ul style="font-size: 14px; line-height: 1.8;">
                <li>‚ùå When using <code>pbjs.setConfig({ ortb2: { source: { tid: "..." } } })</code> (global config)</li>
                <li>‚ùå When using <code>pbjs.setBidderConfig({ bidders: ['yahooAds'], config: { ortb2: { source: { tid: "..." } } } })</code> (bidder-specific config)</li>
            </ul>
            <p style="font-size: 14px;">
                ‚úÖ We call: <code>pbjs.setConfig()</code> AND <code>pbjs.setBidderConfig()</code><br>
                ‚úÖ Config verified: Both <code>pbjs.getConfig('ortb2')</code> and <code>pbjs.getBidderConfig('yahooAds')</code> return <code>{ source: { tid: "..." } }</code><br>
                ‚ùå BUT in adapter: <code>bidderRequest.ortb2.source.tid</code> = <strong>undefined</strong> in BOTH cases<br>
                ‚ùå Result: OpenRTB request has NO <code>source.tid</code> field in EITHER scenario
            </p>
            <p style="font-size: 16px; color: #ce9178;"><strong>Question:</strong> Is our configuration approach wrong, or does Prebid.js not support ortb2.source.tid merging?</p>
        </div>
        
        <div class="issue">
            <h2>‚ùå CRITICAL ISSUE: TID Not Working With setConfig() OR setBidderConfig()</h2>
            <p><strong>Problem:</strong> <code>bidderRequest.ortb2?.source?.tid</code> is <span class="error">undefined</span> even when publisher explicitly sets it</p>
            <p><strong>What We Tried:</strong></p>
            <ul>
                <li>‚úÖ Called <code>pbjs.setConfig({ ortb2: { source: { tid: "..." } } })</code> (global config)</li>
                <li>‚úÖ Verified global config using <code>pbjs.getConfig('ortb2')</code> - shows tid is set</li>
                <li>‚ùå BUT <code>bidderRequest.ortb2?.source?.tid</code> is STILL undefined in buildRequests()</li>
                <li>‚ùå OpenRTB payload has NO <code>source.tid</code> field</li>
            </ul>
            <ul style="margin-top: 10px;">
                <li>‚úÖ Called <code>pbjs.setBidderConfig({ bidders: ['yahooAds'], config: { ortb2: { source: { tid: "..." } } } })</code> (bidder-specific config)</li>
                <li>‚úÖ Verified bidder config using <code>pbjs.getBidderConfig('yahooAds')</code> - shows tid is set</li>
                <li>‚ùå BUT <code>bidderRequest.ortb2?.source?.tid</code> is STILL undefined in buildRequests()</li>
                <li>‚ùå OpenRTB payload has NO <code>source.tid</code> field</li>
            </ul>
            <p><strong>Result:</strong> OpenRTB request has NO <code>source.tid</code> field in BOTH scenarios (not even null)</p>
            <p><strong>Question:</strong> <span class="error">Is our configuration approach wrong? Does ortb2.source.tid not get merged into bidderRequest.ortb2?</span></p>
        </div>

        <div class="expected">
            <h2>‚ùì What We Expected</h2>
            
            <p><strong>Based on Documentation:</strong></p>
            <ol>
                <li>Publisher calls: <code>pbjs.setConfig({ ortb2: { source: { tid: "xyz" } } })</code></li>
                <li>Prebid.js should merge this ortb2 config into the bidderRequest</li>
                <li>Adapter reads: <code>bidderRequest.ortb2.source.tid</code></li>
                <li>Adapter gets value "xyz" and includes it in OpenRTB request</li>
            </ol>
            
            <p><strong>What's Actually Happening (Global Config):</strong></p>
            <ol>
                <li>Publisher calls: <code>pbjs.setConfig({ ortb2: { source: { tid: "xyz" } } })</code> ‚úÖ</li>
                <li><code>pbjs.getConfig('ortb2')</code> returns <code>{ source: { tid: "xyz" } }</code> ‚úÖ</li>
                <li>BUT <code>bidderRequest.ortb2.source.tid</code> = <span class="error">undefined</span> ‚ùå</li>
                <li>OpenRTB request has NO tid field ‚ùå</li>
            </ol>
            
            <p><strong>What's Actually Happening (Bidder-Specific Config):</strong></p>
            <ol>
                <li>Publisher calls: <code>pbjs.setBidderConfig({ bidders: ['yahooAds'], config: { ortb2: { source: { tid: "abc" } } } })</code> ‚úÖ</li>
                <li><code>pbjs.getBidderConfig('yahooAds')</code> returns <code>{ ortb2: { source: { tid: "abc" } } }</code> ‚úÖ</li>
                <li>BUT <code>bidderRequest.ortb2.source.tid</code> = <span class="error">undefined</span> ‚ùå</li>
                <li>OpenRTB request has NO tid field ‚ùå</li>
            </ol>
            
            <p><strong>Critical Questions:</strong></p>
            <ul>
                <li><span class="highlight">Is ortb2.source.tid supposed to be merged into bidderRequest.ortb2?</span></li>
                <li><span class="highlight">If yes, why does neither setConfig() nor setBidderConfig() work?</span></li>
                <li><span class="highlight">Is there a different config location or method for setting source.tid?</span></li>
            </ul>
        </div>

        <h2>üß™ What We're Testing</h2>
        
        <div class="code">
            <strong>Test 1: Global TID via setConfig() ‚ö†Ô∏è</strong>
            <pre>pbjs.setConfig({
  ortb2: {
    source: {
      tid: "global-transaction-id-12345"
    }
  }
});

// Verification: pbjs.getConfig('ortb2').source.tid = ‚úÖ "global-transaction-id-12345"
// Expected: bidderRequest.ortb2.source.tid = "global-transaction-id-12345"
// <span style="color: #f48771;">ACTUAL: bidderRequest.ortb2.source.tid = undefined ‚ùå</span>
// Result: OpenRTB request has NO source.tid field

<span style="color: #ce9178;">Click "Global TID (All Bidders)" button to test</span></pre>
        </div>

        <div class="code">
            <strong>Test 2: Bidder-Specific TID via setBidderConfig() ‚ö†Ô∏è</strong>
            <pre>pbjs.setBidderConfig({
  bidders: ['yahooAds'],
  config: {
    ortb2: {
      source: {
        tid: "yahoo-transaction-id-67890"
      }
    }
  }
});

// Verification: pbjs.getBidderConfig().yahooAds.ortb2.source.tid = ?
// Expected: bidderRequest.ortb2.source.tid = "yahoo-transaction-id-67890"
// <span style="color: #ce9178;">TESTING: Does setBidderConfig merge ortb2.source.tid into bidderRequest? ‚ö†Ô∏è</span>

<span style="color: #ce9178;">Click "Bidder-Specific TID (Yahoo Only)" button to test</span></pre>
        </div>

        <div class="code">
            <strong>üîç Key Finding:</strong>
            <p><strong>setConfig():</strong> We can verify <code>pbjs.getConfig('ortb2').source.tid</code> has the value ‚úÖ</p>
            <p><strong>BUT:</strong> In <code>buildRequests()</code>, <code>bidderRequest.ortb2.source.tid</code> is <strong>undefined</strong> ‚ùå</p>
            <p><strong>setBidderConfig():</strong> Testing if this works differently than setConfig()</p>
            <p><strong>Question:</strong> Does Prebid.js merge ortb2.source.tid from config into bidderRequest.ortb2?</p>
        </div>

        <h2>Adapter Implementation</h2>
        <div class="code">
            <strong>Code in yahooAdsBidAdapter.js (line 291):</strong>
            <pre>source: {
  tid: bidderRequest.ortb2?.source?.tid,
  ext: { ... }
}</pre>
            <p><strong>Current behavior:</strong></p>
            <ul>
                <li>‚ùå <code>bidderRequest.ortb2?.source?.tid</code> is <strong>undefined</strong></li>
                <li>‚ùå Even when publisher sets <code>pbjs.setConfig({ ortb2: { source: { tid: "..." } } })</code></li>
                <li>‚ùå Returns undefined ‚Üí OpenRTB request has NO source.tid field</li>
            </ul>
            <p><strong>Same pattern as:</strong> IX Adapter, Sharethrough Adapter, TTD Adapter, Panxo Adapter</p>
            <p><strong>Question:</strong> Do those adapters have the same issue? Or is there something special about how they configure/use ortb2.source.tid?</p>
        </div>

        <h2>Run Test</h2>
        <p><strong>Choose test scenario:</strong></p>
        
        <button onclick="runDebugTest('none')">‚ùå No TID Set</button>
        <em>‚Üê Publisher does NOT configure TID - shows the issue</em>
        <br><br>
        
        <button onclick="runDebugTest('global')">üåç Global TID (All Bidders)</button>
        <em>‚Üê Set via pbjs.setConfig({ ortb2: { source: { tid: "..." } } })</em>
        <br><br>
        
        <button onclick="runDebugTest('bidder')">üéØ Bidder-Specific TID (Yahoo Only)</button>
        <em>‚Üê Set via pbjs.setBidderConfig({ bidders: ['yahooAds'], config: { ortb2: { source: { tid: "..." } } } })</em>
        <br><br>
        
        <button onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
        
        <div id="ad"></div>

        <h2>üìä Debug Output</h2>

        <div class="log-section">
            <div class="log-title">1. bidderRequest Object Structure</div>
            <pre id="log-bidderRequest">Click "Run Debug Test" to see bidderRequest structure...</pre>
        </div>

        <div class="log-section">
            <div class="log-title">2. Accessing ortb2.source.tid</div>
            <pre id="log-tid-access">Click "Run Debug Test" to see tid access attempts...</pre>
        </div>

        <div class="log-section">
            <div class="log-title">3. Actual Network Request Payload</div>
            <pre id="log-network">Click "Run Debug Test" to see actual request sent to Yahoo...</pre>
        </div>

        <div class="log-section">
            <div class="log-title">4. Alternative Values Available</div>
            <pre id="log-alternatives">Click "Run Debug Test" to see alternative values...</pre>
        </div>

        <h2>üö® CRITICAL Questions for Prebid Team</h2>
        <div class="code">
            <ol>
                <li><strong>Is our setConfig() approach correct?</strong>
                    <br>We are calling:
                    <pre style="margin: 10px 0; padding: 10px; background: #1e1e1e;">pbjs.setConfig({
  ortb2: {
    source: {
      tid: "transaction-id-12345"
    }
  }
});</pre>
                    Is this the correct way to set source.tid?</li>
                
                <li><strong>Why is ortb2.source.tid NOT being merged into bidderRequest?</strong>
                    <br>We can verify the config is set:
                    <ul>
                        <li><code>pbjs.getConfig('ortb2')</code> returns <code>{ source: { tid: "..." } }</code> ‚úÖ</li>
                        <li>BUT <code>bidderRequest.ortb2.source.tid</code> = <span class="error">undefined</span> ‚ùå</li>
                    </ul>
                    Is ortb2.source.tid supposed to be merged into bidderRequest.ortb2?</li>
                
                <li><strong>Is there a different config location for source.tid?</strong>
                    <br>Should we be setting it somewhere else? Is <code>ortb2.source.tid</code> not supported in setConfig()?</li>
                
                <li><strong>Does setBidderConfig() work for ortb2.source.tid?</strong>
                    <br>Should we use setBidderConfig instead? Or does that have the same issue?</li>
                
                <li><strong>How do IX, Sharethrough, TTD adapters work?</strong>
                    <br>They all use <code>bidderRequest.ortb2?.source?.tid</code> - do they have the same issue?
                    <br>Do publishers need special configuration for those adapters?</li>
                
                <li><strong>Is this a Prebid.js bug?</strong>
                    <br>Should ortb2.source.tid from setConfig() automatically be merged into bidderRequest.ortb2?
                    <br>Or is ortb2.source.tid simply not supported/implemented yet?</li>
            </ol>
        </div>

        <h2>Test Environment</h2>
        <div class="code">
            <strong>Prebid.js Version:</strong> <span id="prebid-version">Loading...</span><br>
            <strong>Yahoo Ads Adapter:</strong> Loaded from /build/dev/prebid.js<br>
            <strong>Test Mode:</strong> e2etest enabled (no real credentials needed)
        </div>
    </div>

    <script src="../../build/dev/prebid.js"></script>
    
    <script>
        // Initialize Prebid
        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        // Intercept XHR to capture request payload
        let capturedPayload = null;
        (function() {
            const originalXHR = window.XMLHttpRequest;
            function newXHR() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                const originalSend = xhr.send;
                
                let requestURL = '';
                
                xhr.open = function(method, url) {
                    requestURL = url;
                    return originalOpen.apply(this, arguments);
                };
                
                xhr.send = function(body) {
                    if (requestURL && requestURL.includes('pubgw.yahoo.com')) {
                        if (body) {
                            try {
                                capturedPayload = JSON.parse(body);
                                displayNetworkPayload(capturedPayload);
                            } catch (e) {
                                console.error('Error parsing payload:', e);
                            }
                        }
                    }
                    return originalSend.apply(this, arguments);
                };
                
                return xhr;
            }
            window.XMLHttpRequest = newXHR;
        })();

        // Monkey-patch buildRequests to capture bidderRequest
        pbjs.que.push(function() {
            document.getElementById('prebid-version').textContent = pbjs.version || 'Unknown';

            const originalBuildRequests = pbjs.bidderRegistry?.yahooAds?.buildRequests;
            
            if (originalBuildRequests) {
                pbjs.bidderRegistry.yahooAds.buildRequests = function(validBidRequests, bidderRequest) {
                    console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #569cd6');
                    console.log('%cüîç buildRequests() CALLED', 'color: #569cd6; font-weight: bold; font-size: 14px');
                    console.log('%c‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'color: #569cd6');
                    
                    // Check what's in config vs bidderRequest
                    const globalOrtb2 = pbjs.getConfig('ortb2');
                    const bidderConfig = pbjs.getBidderConfig();
                    const yahooConfig = bidderConfig?.yahooAds;
                    
                    console.log('%cüìã Comparison: Config vs bidderRequest', 'color: #ce9178; font-weight: bold');
                    console.log('%c1. Global Config (pbjs.getConfig):', 'color: #9cdcfe');
                    console.log('   ortb2.source.tid:', globalOrtb2?.source?.tid);
                    
                    console.log('%c2. Bidder Config (pbjs.getBidderConfig):', 'color: #9cdcfe');
                    console.log('   yahooAds.ortb2.source.tid:', yahooConfig?.ortb2?.source?.tid);
                    
                    console.log('%c3. bidderRequest (in buildRequests):', 'color: #9cdcfe');
                    console.log('   bidderRequest.ortb2?.source?.tid:', bidderRequest.ortb2?.source?.tid);
                    
                    if (!bidderRequest.ortb2?.source?.tid) {
                        if (globalOrtb2?.source?.tid || yahooConfig?.ortb2?.source?.tid) {
                            console.log('%c‚ùå ISSUE CONFIRMED:', 'color: #f48771; font-weight: bold; font-size: 14px');
                            console.log('%c   Config HAS tid but bidderRequest does NOT!', 'color: #f48771');
                            console.log('%c   This means ortb2.source.tid is NOT being merged into bidderRequest', 'color: #f48771');
                        }
                    } else {
                        console.log('%c‚úÖ SUCCESS: tid found in bidderRequest!', 'color: #4ec9b0; font-weight: bold');
                    }
                    
                    // Log everything we need to debug
                    logBidderRequest(bidderRequest);
                    logTidAccess(bidderRequest);
                    logAlternatives(bidderRequest, validBidRequests);
                    
                    // Call original
                    return originalBuildRequests.apply(this, arguments);
                };
            }
        });

        function logBidderRequest(bidderRequest) {
            const output = [];
            output.push('<span class="info">Full bidderRequest object:</span>');
            output.push(JSON.stringify({
                auctionId: bidderRequest.auctionId,
                bidderRequestId: bidderRequest.bidderRequestId,
                bidderCode: bidderRequest.bidderCode,
                timeout: bidderRequest.timeout,
                'ortb2 (full)': bidderRequest.ortb2,
                'Has ortb2?': !!bidderRequest.ortb2,
                'Has ortb2.source?': !!bidderRequest.ortb2?.source,
                'Has ortb2.source.tid?': !!bidderRequest.ortb2?.source?.tid,
                bidsCount: bidderRequest.bids?.length || 0
            }, null, 2));
            
            document.getElementById('log-bidderRequest').innerHTML = output.join('\n');
        }

        function logTidAccess(bidderRequest) {
            const output = [];
            
            output.push('<span class="warning">Attempting to access tid...</span>\n');
            
            // Try different access methods
            output.push('1. bidderRequest.ortb2?.source?.tid');
            const tid1 = bidderRequest.ortb2?.source?.tid;
            output.push(`   Result: <span class="${tid1 ? 'success' : 'error'}">${JSON.stringify(tid1)}</span>\n`);
            
            output.push('2. bidderRequest.ortb2 && bidderRequest.ortb2.source && bidderRequest.ortb2.source.tid');
            const tid2 = bidderRequest.ortb2 && bidderRequest.ortb2.source && bidderRequest.ortb2.source.tid;
            output.push(`   Result: <span class="${tid2 ? 'success' : 'error'}">${JSON.stringify(tid2)}</span>\n`);
            
            output.push('3. Check if ortb2 object exists');
            output.push(`   bidderRequest.ortb2 = <span class="${bidderRequest.ortb2 ? 'success' : 'error'}">${bidderRequest.ortb2 ? 'EXISTS' : 'undefined'}</span>`);
            
            if (bidderRequest.ortb2) {
                output.push(`   typeof ortb2 = ${typeof bidderRequest.ortb2}`);
                output.push(`   ortb2 keys = ${Object.keys(bidderRequest.ortb2).join(', ')}`);
                
                output.push('\n4. Check if ortb2.source exists');
                output.push(`   bidderRequest.ortb2.source = <span class="${bidderRequest.ortb2.source ? 'success' : 'error'}">${bidderRequest.ortb2.source ? 'EXISTS' : 'undefined'}</span>`);
                
                if (bidderRequest.ortb2.source) {
                    output.push(`   typeof ortb2.source = ${typeof bidderRequest.ortb2.source}`);
                    output.push(`   ortb2.source keys = ${Object.keys(bidderRequest.ortb2.source).join(', ')}`);
                    output.push(`   ortb2.source content = ${JSON.stringify(bidderRequest.ortb2.source, null, 2)}`);
                } else {
                    output.push(`   <span class="error">‚ùå ortb2.source does not exist!</span>`);
                }
            } else {
                output.push(`   <span class="error">‚ùå ortb2 object does not exist!</span>`);
            }
            
            document.getElementById('log-tid-access').innerHTML = output.join('\n');
        }

        function logAlternatives(bidderRequest, validBidRequests) {
            const output = [];
            
            output.push('<span class="info">Checking ortb2.source.tid at different levels:</span>\n');
            
            output.push('<span class="success">1. BIDDER-REQUEST LEVEL (Global or Bidder-Specific via setBidderConfig):</span>');
            output.push('   bidderRequest.ortb2?.source?.tid');
            const hasTid = bidderRequest.ortb2?.source?.tid;
            output.push(`   Value: <span class="${hasTid ? 'success' : 'error'}">${JSON.stringify(bidderRequest.ortb2?.source?.tid) || 'undefined'}</span>`);
            if (hasTid) {
                output.push(`   <span class="success">‚úÖ TID is present!</span>`);
            } else {
                output.push(`   <span class="error">‚ùå TID is UNDEFINED - this is the issue!</span>`);
            }
            output.push(`   Configuration: setConfig() or setBidderConfig()\n`);
            
            output.push('<span class="info">2. ORTB2 OBJECT STRUCTURE:</span>');
            output.push(`   bidderRequest.ortb2 exists? <span class="${bidderRequest.ortb2 ? 'success' : 'error'}">${!!bidderRequest.ortb2}</span>`);
            if (bidderRequest.ortb2) {
                output.push(`   bidderRequest.ortb2.source exists? <span class="${bidderRequest.ortb2.source ? 'success' : 'error'}">${!!bidderRequest.ortb2.source}</span>`);
                if (bidderRequest.ortb2.source) {
                    output.push(`   bidderRequest.ortb2.source.tid exists? <span class="${bidderRequest.ortb2.source.tid ? 'success' : 'error'}">${!!bidderRequest.ortb2.source.tid}</span>`);
                    output.push(`   ortb2.source content: ${JSON.stringify(bidderRequest.ortb2.source)}`);
                } else {
                    output.push(`   <span class="error">‚ùå ortb2.source object does not exist!</span>`);
                }
            } else {
                output.push(`   <span class="error">‚ùå ortb2 object does not exist!</span>`);
            }
            
            output.push('\n<span class="warning">Key Questions:</span>');
            output.push('1. Why is bidderRequest.ortb2?.source?.tid undefined without explicit configuration?');
            output.push('2. Is setBidderConfig() properly merging ortb2.source.tid into bidderRequest?');
            output.push('3. Should Prebid.js provide a default value for source.tid?');
            
            document.getElementById('log-alternatives').innerHTML = output.join('\n');
        }

        function displayNetworkPayload(payload) {
            const output = [];
            
            output.push('<span class="info">Actual payload sent to Yahoo:</span>\n');
            
            if (payload.source) {
                output.push('<span class="warning">source object:</span>');
                output.push(JSON.stringify(payload.source, null, 2));
                output.push('');
                
                if (payload.source.tid === null || payload.source.tid === undefined) {
                    output.push(`<span class="error">‚ùå ISSUE CONFIRMED: source.tid = ${JSON.stringify(payload.source.tid)}</span>`);
                    output.push('<span class="error">This is the problem we need to solve!</span>');
                } else {
                    output.push(`<span class="success">‚úÖ source.tid = "${payload.source.tid}"</span>`);
                }
            } else {
                output.push('<span class="error">‚ùå No source object in payload!</span>');
            }
            
            output.push('\n<span class="info">Full payload (abbreviated):</span>');
            output.push(JSON.stringify({
                id: payload.id,
                source: payload.source,
                imp: payload.imp?.length + ' impressions',
                // Truncate other fields for readability
            }, null, 2));
            
            document.getElementById('log-network').innerHTML = output.join('\n');
        }

        function clearLogs() {
            document.getElementById('log-bidderRequest').innerHTML = 'Logs cleared. Click "Run Debug Test" to run again.';
            document.getElementById('log-tid-access').innerHTML = 'Logs cleared. Click "Run Debug Test" to run again.';
            document.getElementById('log-network').innerHTML = 'Logs cleared. Click "Run Debug Test" to run again.';
            document.getElementById('log-alternatives').innerHTML = 'Logs cleared. Click "Run Debug Test" to run again.';
        }

        function runDebugTest(tidLevel) {
            clearLogs();
            
            // Base ad unit
            const adUnits = [{
                code: 'ad',
                mediaTypes: {
                    banner: {
                        sizes: [[300, 250]]
                    }
                },
                bids: [{
                    bidder: 'yahooAds',
                    params: {
                        pubId: '8a969516017a7a396ec539d97f540011',
                        siteId: '1234567',
                        testing: {
                            e2etest: true
                        }
                    }
                }]
            }];

            pbjs.que.push(function() {
                // Base config
                const config = {
                    debug: true
                };
                
                const logDiv = document.getElementById('log-bidderRequest');
                
                if (tidLevel === 'none') {
                    // No TID configured
                    console.log('%c‚ùå No TID Configured', 'color: #f48771; font-weight: bold');
                    console.log('%cPublisher did NOT set tid - ortb2.source.tid will be undefined', 'color: #9cdcfe');
                    
                    logDiv.innerHTML = '<span class="error">‚ùå No TID Configured</span>\n' +
                        'Publisher did NOT set ortb2.source.tid\n' +
                        'Result: bidderRequest.ortb2?.source?.tid will be undefined\n\n' +
                        'Waiting for buildRequests() to be called...';
                        
                } else if (tidLevel === 'global') {
                    // Global TID - applies to ALL bidders
                    const globalTid = 'global-tid-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    
                    config.ortb2 = {
                        source: {
                            tid: globalTid
                        }
                    };
                    
                    console.log('%cüåç Global TID Set (All Bidders)', 'color: #4ec9b0; font-weight: bold');
                    console.log('%cCode:', 'color: #569cd6');
                    console.log('%cpbjs.setConfig({', 'color: #9cdcfe');
                    console.log('%c  ortb2: {', 'color: #9cdcfe');
                    console.log('%c    source: {', 'color: #9cdcfe');
                    console.log('%c      tid: "' + globalTid + '"', 'color: #ce9178');
                    console.log('%c    }', 'color: #9cdcfe');
                    console.log('%c  }', 'color: #9cdcfe');
                    console.log('%c});', 'color: #9cdcfe');
                    
                    logDiv.innerHTML = '<span class="success">‚úÖ GLOBAL TID Configured (All Bidders)</span>\n\n' +
                        '<span class="info">Configuration Method:</span>\n' +
                        'pbjs.setConfig({\n' +
                        '  ortb2: {\n' +
                        '    source: {\n' +
                        '      tid: <span class="highlight">"' + globalTid + '"</span>\n' +
                        '    }\n' +
                        '  }\n' +
                        '});\n\n' +
                        '<span class="info">Scope:</span> Applies to ALL bidders in the auction\n' +
                        '<span class="info">Expected:</span> bidderRequest.ortb2.source.tid = "' + globalTid + '"\n\n' +
                        'Waiting for buildRequests() to be called...';
                    
                    // Verify the config was set (after a short delay)
                    setTimeout(function() {
                        const ortb2Config = pbjs.getConfig('ortb2');
                        console.log('%cüîç Verifying setConfig:', 'color: #569cd6; font-weight: bold');
                        console.log('ortb2 config:', ortb2Config);
                        console.log('ortb2.source:', ortb2Config?.source);
                        console.log('ortb2.source.tid:', ortb2Config?.source?.tid);
                        
                        if (ortb2Config?.source?.tid === globalTid) {
                            console.log('%c‚úÖ SUCCESS: setConfig stored the TID correctly!', 'color: #4ec9b0; font-weight: bold');
                            console.log('%cNOW checking if this gets merged into bidderRequest.ortb2...', 'color: #ce9178');
                        } else {
                            console.log('%c‚ùå ISSUE: TID not found in global ortb2 config', 'color: #f48771; font-weight: bold');
                        }
                    }, 100);
                        
                } else if (tidLevel === 'bidder') {
                    // Bidder-specific TID - only for Yahoo Ads using setBidderConfig
                    const bidderTid = 'yahoo-tid-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    
                    console.log('%cüéØ Bidder-Specific TID Set (Yahoo Ads Only)', 'color: #4ec9b0; font-weight: bold');
                    console.log('%cCode (Using setBidderConfig):', 'color: #569cd6');
                    console.log('%cpbjs.setBidderConfig({', 'color: #9cdcfe');
                    console.log('%c  bidders: ["yahooAds"],', 'color: #9cdcfe');
                    console.log('%c  config: {', 'color: #9cdcfe');
                    console.log('%c    ortb2: {', 'color: #9cdcfe');
                    console.log('%c      source: {', 'color: #9cdcfe');
                    console.log('%c        tid: "' + bidderTid + '"', 'color: #ce9178');
                    console.log('%c      }', 'color: #9cdcfe');
                    console.log('%c    }', 'color: #9cdcfe');
                    console.log('%c  }', 'color: #9cdcfe');
                    console.log('%c});', 'color: #9cdcfe');
                    
                    logDiv.innerHTML = '<span class="success">‚úÖ BIDDER-SPECIFIC TID Configured (Yahoo Ads Only)</span>\n\n' +
                        '<span class="info">Configuration Method (setBidderConfig):</span>\n' +
                        'pbjs.setBidderConfig({\n' +
                        '  bidders: ["yahooAds"],\n' +
                        '  config: {\n' +
                        '    ortb2: {\n' +
                        '      source: {\n' +
                        '        tid: <span class="highlight">"' + bidderTid + '"</span>\n' +
                        '      }\n' +
                        '    }\n' +
                        '  }\n' +
                        '});\n\n' +
                        '<span class="info">Scope:</span> Applies only to yahooAds bidder\n' +
                        '<span class="info">Expected:</span> bidderRequest.ortb2.source.tid = "' + bidderTid + '"\n\n' +
                        '<span class="warning">Note:</span> Testing if setBidderConfig() properly merges this into bidderRequest.ortb2\n\n' +
                        'Waiting for buildRequests() to be called...';
                    
                    // Actually call setBidderConfig
                    pbjs.setBidderConfig({
                        bidders: ['yahooAds'],
                        config: {
                            ortb2: {
                                source: {
                                    tid: bidderTid
                                }
                            }
                        }
                    });
                    
                    // Verify the config was set (after a short delay)
                    setTimeout(function() {
                        const bidderConfig = pbjs.getBidderConfig();
                        console.log('%cüîç Verifying setBidderConfig:', 'color: #569cd6; font-weight: bold');
                        console.log('Full bidderConfig:', bidderConfig);
                        
                        const yahooConfig = bidderConfig?.yahooAds;
                        if (yahooConfig) {
                            console.log('%c‚úÖ yahooAds config found:', 'color: #4ec9b0', yahooConfig);
                            console.log('%c   ortb2:', 'color: #9cdcfe', yahooConfig.ortb2);
                            console.log('%c   ortb2.source:', 'color: #9cdcfe', yahooConfig.ortb2?.source);
                            console.log('%c   ortb2.source.tid:', 'color: #9cdcfe', yahooConfig.ortb2?.source?.tid);
                            
                            if (yahooConfig.ortb2?.source?.tid === bidderTid) {
                                console.log('%c‚úÖ SUCCESS: setBidderConfig stored the TID correctly!', 'color: #4ec9b0; font-weight: bold');
                            } else {
                                console.log('%c‚ùå ISSUE: TID not found in bidder config', 'color: #f48771; font-weight: bold');
                            }
                        } else {
                            console.log('%c‚ùå No config found for yahooAds bidder', 'color: #f48771');
                        }
                    }, 100);
                }
                
                pbjs.setConfig(config);
                
                pbjs.removeAdUnit();
                pbjs.addAdUnits(adUnits);
                
                pbjs.requestBids({
                    timeout: 3000,
                    bidsBackHandler: function() {
                        console.log('Bids back');
                    }
                });
            });
        }

        // Auto-display version on load
        pbjs.que.push(function() {
            document.getElementById('prebid-version').textContent = pbjs.version || 'Unknown';
        });
    </script>
</body>
</html>
