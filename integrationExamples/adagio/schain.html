<!DOCTYPE html>
<html>
<head>
  <title>AdagioBidAdapter integration example</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
  <script>
    var PREBID_TIMEOUT = 2000;
    var MAX_RETRIES = 10;

    var googletag = googletag || {};
    googletag.cmd = googletag.cmd || [];

    googletag.cmd.push(function () {
      googletag.pubads().disableInitialLoad();
    });

    var pbjs = pbjs || {};
    pbjs.que = pbjs.que || [];
    pbjs.retries = 0;

    var apntag = {
      debug: 5
    };

    var ast_debug = true;

    var date = new Date().getTime();

    /* $$PREBID_GLOBAL$$.initAdserver will be called either when all bids are back, or
    when the timeout is reached.
    */
    function initAdserver() {
      if (pbjs.initAdserverSet) return;
      if(!googletag.pubadsReady && pbjs.retries <= MAX_RETRIES) {
        setTimeout(initAdserver, 50); //poll ms can be adjusted as desired.
        pbjs.retries++;
        return;
      }
      googletag.cmd.push(function () {
        pbjs.que.push(function () {
          pbjs.setTargetingForGPTAsync();
        });
        console.log('REFRESH GPT TAG');
        googletag.pubads().refresh();
      });
      pbjs.initAdserverSet = true;
    }

    // Load GPT when timeout is reached.
    // setTimeout(initAdserver, PREBID_TIMEOUT);

    // Load the Prebid Javascript Library Async. We recommend loading it immediately after
    // the initAdserver() and setTimeout functions.
    (function () {
      var d = document;
      var pbs = d.createElement("script");
      pbs.type = "text/javascript";
      pbs.src = 'http://adagio.io:9999/build/dev/prebid.js';
      var target = d.getElementsByTagName("head")[0];
      target.insertBefore(pbs, target.firstChild);
    })();

    //load GPT library here
    (function () {
      var gads = document.createElement('script');
      gads.async = true;
      gads.type = 'text/javascript';
      var useSSL = 'https:' == document.location.protocol;
      gads.src = (useSSL ? 'https:' : 'http:') +
          '//www.googletagservices.com/tag/js/gpt.js';
      var node = document.getElementsByTagName('script')[0];
      node.parentNode.insertBefore(gads, node);
    })();

    pbjs.que.push(function () {

      const customConfigObject = {
        "buckets" : [{
          "precision": 2,
          "min" : 0,
          "max" : 10,
          "increment" : 1
        }]
      };

      pbjs.setConfig({
        debug: 1,
        priceGranularity: customConfigObject,
        // http://prebid.org/dev-docs/modules/consentManagement.html
        consentManagement: {
          cmpApi: 'test',
          timeout: 4000,
          allowAuctionWithoutConsent: false
        },
        // https://github.com/prebid/Prebid.js/blob/master/modules/schain.md
        schain: {
          "validation": "strict",
          "config": {
            "ver":"1.0",
            "complete": 1,
            "nodes": [
              {
              "asi":"indirectseller.com",
              "sid":"00001",
              "hp":1
              },

              {
              "asi":"indirectseller-2.com",
              "sid":"00002",
              "hp":1
              }
            ]
          }
        }
      });
      var adUnits = [
        {
          // PAVE
          code: '/21686208299/pave',
          mediaTypes: {
            banner: { sizes: [[300, 250]] },
          },
          bids: [
            {
              bidder: 'adagio',
              params: {
                organizationId: '1004', // Required - Organization ID from Adagio.
                site: 'maville', // Required - Site Name from Adagio.
                placement: 'pave_top', // Required - Placement from Adagio. Refers to the placement of an ad unit in a page.
                adUnitElementId: 'div-gpt-ad-1542984663788-0',
                pagetype: 'topic', // Recommended - Page type from Adagio.
                environment: 'desktop', // Optional - Environment from Adagio.
              }
            }
          ]
        },
        {
          // BANNER
          code: '21686208299/banner',
          mediaTypes: {
            banner: { sizes: [[728, 90]] },
          },
          bids: [
            {
              bidder: 'adagio',
              params: {
                organizationId: '1004', // Required - Organization ID from Adagio.
                site: 'maville', // Required - Site Name from Adagio.
                placement: 'pave_top', // Required - Placement from Adagio. Refers to the placement of an ad unit in a page.
                adUnitElementId: 'div-gpt-ad-1582897131048-0',
                pagetype: 'topic', // Recommended - Page type from Adagio.
                environment: 'desktop', // Optional - Environment from Adagio.
              }
            }
          ]
        }
      ];

      pbjs.setBidderConfig({
        bidders: ["adagio"],  // one or more bidders
        config: {
          // http://prebid.org/dev-docs/publisher-api-reference.html#module_pbjs.setBidderConfig
          // la doc spécifie qu'il faut rajouter le nom du bidder en clé de l'objet config
          // c'est une erreur.
          schain: {
            validation: 'relaxed',
            config: {
              ver: '1.0',
              complete: 1,
              nodes: [{
                asi: 'ssp.test',
                sid: '00001',
                hp: 1
              }]
            }
          },
        }
      });

      //add the adUnits
      pbjs.addAdUnits(adUnits);

      pbjs.bidderSettings = {
        adagio: {
          alwaysUseBid: true, // <-- new field - always send these custom keys for the specified bidder
          adserverTargeting: [
            {
              key: "adagiojs",
              val: function (bidResponse) {
                return 1;
              }
            }
          ]
        }
      };

      pbjs.requestBids({
        bidsBackHandler: function (bidResponses) {
          console.log('\n-------------------\n');
          console.log('Adagio debug');
          console.log('bidResponses: ', bidResponses);
          console.log('-------------------\n');

          initAdserver();
          // var highestCpmBids = pbjs.getHighestCpmBids('/21686208299/native2');
          // console.log('HIGHEST', highestCpmBids);
          // pbjs.renderAd(document, highestCpmBids[0].adId);
        },

        timeout: 1000
      });
    });

    googletag.cmd.push(function() {
      googletag.defineSlot('/21686208299/pave', [[300, 250], [300, 600], [640, 480]], 'div-gpt-ad-1542984663788-0').addService(googletag.pubads());
      googletag.defineSlot('/21686208299/banner', [728, 90], 'div-gpt-ad-1582897131048-0').setTargeting('hb_pb', ['1.00', '0.90']).addService(googletag.pubads());
      googletag.pubads().enableSingleRequest();
      googletag.enableServices();
    });


  </script>
</head>
<body>
  <div class="container">
    <div class="row" style="background-color: honeydew;">
      <div class="">
        <h2>Adagio Bidder with <code>schain</code> config</h2>
      </div>
    </div>
    <div class="row">
      <div class="col-md-8">

        <!-- /21686208299/banner -->
        <div id="div-gpt-ad-1582897131048-0" style="width: 728px; height: 90px;"></div>

        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
        <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Beatae tempora consequuntur quis? Ipsam voluptatibus ipsum
          quis architecto iure earum aperiam reiciendis quaerat beatae, fugiat, minus officia nesciunt adipisci? Aliquam,
          similique!
        </p>
      </div>
      <div class="col-md-4">
        <div id="div-gpt-ad-1542984663788-0" style="background-color: darkkhaki;"></div>
      </div>
    </div>
  </div>
</body>
</html>
