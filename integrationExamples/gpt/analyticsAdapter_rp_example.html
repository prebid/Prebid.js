<html>
<head>
    <script>
        var PREBID_TIMEOUT = 3000;
        var DIV_1 = 'div-1';
        // var DIV_1_SIZES = [[640,480]];
        var DIV_1_SIZES = [[640,480], [300, 250]];
        var DIV_2 = 'div-2';
        var DIV_2_SIZES = [[300, 250],[300, 600]];
        
        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];

        function initAdserver() {
            if (pbjs.initAdserverSet) return;
            (function() {
                var gads = document.createElement('script');
                gads.async = true;
                gads.type = 'text/javascript';
                var useSSL = 'https:' == document.location.protocol;
                gads.src = (useSSL ? 'https:' : 'http:') + '//www.googletagservices.com/tag/js/gpt.js';
                var node = document.getElementsByTagName('script')[0];
                node.parentNode.insertBefore(gads, node);
            })();
            pbjs.initAdserverSet = true;
        };
        setTimeout(initAdserver, PREBID_TIMEOUT);

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];
        (function() {
            var pbjsEl = document.createElement("script");
            pbjsEl.type = "text/javascript";
            pbjsEl.async = true;
            pbjsEl.src = '/build/dev/prebid.js';
            var pbjsTargetEl = document.getElementsByTagName("head")[0];
            pbjsTargetEl.insertBefore(pbjsEl, pbjsTargetEl.firstChild);
        })();
        
        pbjs.que.push(function() {
            var adUnits = [{
                    code: DIV_1,
                    mediaTypes: {
                        banner: {
                            sizes: DIV_1_SIZES
                        },
                        video: {
                            playerSize: DIV_1_SIZES,
                        }
                    },
                    bids: [
                        {
                            bidder: "rubicon",
                            params: {
                                accountId: 1001,
                                siteId: 113932,
                                zoneId: 535510,
                                video: {
                                    context: 'instream',
                                    playerSize: [640, 480],
                                    mimes: ['video/mp4', 'video/x-ms-wmv'],
                                    protocols: [2, 5],
                                    maxduration: 30,
                                    linearity: 1,
                                    api: [2]
                                }
                            },
                        }
                    ]
                },{
                    code: DIV_2,
                    mediaTypes: {
                        banner: {
                            sizes: DIV_2_SIZES
                        }
                    },
                    bids: [
                        {
                            bidder: "rubicon",
                            params: {
                                accountId: 1001,
                                siteId: 113932,
                                zoneId: 535510
                            }
                        }
                    ]
                }
            ];

            pbjs.setConfig({
                debug: true,
                consentManagement: {
                    allowAuctionWithoutConsent: true
                },
                bidderTimeout: 3000,
                s2sConfig: {
                    'accountId': 'abc',
                    'adapter': 'prebidServer',
                    'bidders': ['rubicon'],
                    'defaultVendor': 'rubicon',
                    'enabled': true,
                    'endpoint': '//prebid-server.rubiconproject.com/openrtb2/auction',
                    'syncEndpoint': '//prebid-server.rubiconproject.com/cookie_sync',
                    'timeout': 750
                }
            });

            pbjs.addAdUnits(adUnits);

            pbjs.enableAnalytics({
                provider: 'rubicon',
                options: {
                    accountId: 1001,
                    endpoint: '//localhost:9999/event'
                }
            });

            pbjs.requestBids({
                bidsBackHandler: function(bidResponses) {
                    initAdserver();
                }
            })
        });
    </script>

    <script>
        googletag.cmd.push(function() {
            googletag.defineSlot('/19968336/header-bid-tag-0', DIV_1_SIZES, DIV_1).addService(googletag.pubads());
            googletag.defineSlot('/112115922/FL_PB_MedRect', DIV_2_SIZES, DIV_2).addService(googletag.pubads());
            // googletag.defineSlot('/19968336/header-bid-tag1', DIV_2_SIZES, DIV_2).addService(googletag.pubads());
            
            pbjs.que.push(function() {
                pbjs.setTargetingForGPTAsync();
            });

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
    <style>
        div{
            border: 1px solid black;
            border-radius: 2px;
            min-height: 20px;
        }
    </style>
</head>

<body>
    <h2>Prebid.js Rubicon Analytics Adapter Example</h2>
    
    <h5>Div-1</h5>
    <div id='div-1'>
        <script>
            googletag.cmd.push(function() {
                googletag.display(DIV_1); 
            });
        </script>
    </div>

    <h5>Div-2</h5>
    <div id='div-2'>
        <script>
            googletag.cmd.push(function() {
                googletag.display(DIV_2);
            });
        </script>
    </div>
</body>
</html>
