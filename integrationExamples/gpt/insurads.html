<html>

<head>
    <script async src="../../build/dev/prebid.js"></script>
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
    <script>
        var FAILSAFE_TIMEOUT = 5300;
        var PREBID_TIMEOUT = 2000;

        var adUnits = [{
            code: 'div-gpt-ad-1460505748561-0',
            mediaTypes: {
                banner: {
                    sizes: [[300, 250]],
                }
            },

            // Replace this object to test a new Adapter!
            bids: [{
                bidder: 'insurads',
                params: {
                    tagId: 'testnexx'
                }
            }]
        }];

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

    </script>

    <script>
        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];
        googletag.cmd.push(function () {
            googletag.pubads().disableInitialLoad();
        });

        pbjs.que.push(function () {

            pbjs.setConfig({
                enableTIDs: true,
                debug: true, // use only for testing, remove in production
            });

            // You can set up gzip compression like so, and the adapter will use this setting when sending bid requests
            // pbjs.setBidderConfig({
            //     bidders: ['insurads'],
            //     config: {
            //         gzipEnabled: 'true',
            //     }
            // });

            
            pbjs.bidderSettings = {
                insurads: {
                    storageAllowed : true
                }
            }

            pbjs.onEvent('bidRequested', function (bidRequest) {
                console.log('Prebid bidRequested!!!!' + bidRequest.bidderCode);
            });

            pbjs.addAdUnits(adUnits);

            pbjs.requestBids({
                bidsBackHandler: sendAdserverRequest,
                timeout: PREBID_TIMEOUT
            });
        });

        function sendAdserverRequest() {
            if (pbjs.adserverRequestSent) return;
            pbjs.adserverRequestSent = true;
            googletag.cmd.push(function () {
                if (pbjs.libLoaded) {
                    pbjs.que.push(function () {
                        pbjs.setTargetingForGPTAsync();
                        console.log('Calling googletag.pubads().refresh');
                        googletag.pubads().refresh();
                    });
                } else {
                    googletag.pubads().refresh();
                }
            });
        }

        setTimeout(function () {
            sendAdserverRequest();
        }, FAILSAFE_TIMEOUT);

    </script>

    <script>
        googletag.cmd.push(function () {
            googletag.defineSlot('/19968336/header-bid-tag-0', [[300, 250], [300, 600]], 'div-gpt-ad-1460505748561-0').addService(googletag.pubads());

            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
            googletag.pubads().enableLazyLoad({
                fetchMarginPercent: 200,
                renderMarginPercent: 100,
                mobileScaling: 2.0
            });
        });
    </script>
</head>

<body>
    <h2>Prebid.js Test</h2>
    <h5>Div-1</h5>
    <div id='div-gpt-ad-1460505748561-0'>
        <script type='text/javascript'>
            googletag.cmd.push(function () { googletag.display('div-gpt-ad-1460505748561-0'); });
        </script>
    </div>

</body>

</html>
