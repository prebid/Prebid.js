<!DOCTYPE html>
<html lang="en">
<head>
    <title>Optable RTD submodule example - Prebid.js</title>
    <script async src="https://securepubads.g.doubleclick.net/tag/js/gpt.js"></script>
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">
    <script async src="../../build/dev/prebid.js"></script>
    <meta charset="UTF-8">
    <style>
        body {
            color: #222;
            font-size: 1.5em;
            line-height: 1.6;
            font-family: "Raleway", "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
        }

        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .delim {
            margin: 27px 0 35px;
            border-width: 0;
            border-top: 1px solid #e1e1e1;
        }

        h1 {
            font-size: 30px;
            line-height: 1.35;
            font-weight: 100;
            letter-spacing: -0.5px;
        }

        a {
            color: #1eaedb;
            text-decoration: underline;
        }

        @media (min-width: 768px) {
            .container {
                padding: 0;
            }
        }

        #enriched-optable-data {
            font-size: 12px;
            max-width: 100%;
            overflow-x: scroll;
            padding: 16px;
            background-color: #efefef;
            border-radius: 6px;
        }
    </style>
    <script>
        var PREBID_TIMEOUT = 3000;
        var FAILSAFE_TIMEOUT = 5000;

        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];

        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];

        function initAdserver() {
            if (pbjs.initAdserverSet) return;

            googletag.cmd.push(function () {
                if (pbjs.libLoaded) {
                    pbjs.que.push(function () {
                        pbjs.setTargetingForGPTAsync();
                        googletag.pubads().refresh();
                    });
                } else {
                    googletag.pubads().refresh();
                }
            });

            pbjs.initAdserverSet = true;
        }

        pbjs.que.push(function () {
            var adUnits = [
                {
                    code: '/22081946781/web-sdk-demo-gam360/header-ad',
                    mediaTypes: {
                        banner: {
                            sizes: [[728, 90]],
                        },
                    },
                    bids: [{
                        bidder: 'appnexus',
                        params: {
                            placementId: 13232392,
                        }
                    }]
                },
                {
                    code: '/22081946781/web-sdk-demo-gam360/box-ad',
                    mediaTypes: {
                        banner: {
                            sizes: [[250, 250], [300, 250], [200, 200]],
                        },
                    },
                    bids: [{
                        bidder: 'appnexus',
                        params: {
                            placementId: 13232392,
                        }
                    }]
                },
                {
                    code: '/22081946781/web-sdk-demo-gam360/footer-ad',
                    mediaTypes: {
                        banner: {
                            sizes: [[728, 90]],
                        },
                    },
                    bids: [{
                        bidder: 'appnexus',
                        params: {
                            placementId: 13232392,
                        }
                    }]
                },
            ];

            pbjs.setConfig({
                debug: true, // use only for testing, remove in production
                realTimeData: {
                    auctionDelay: 1000, // should be set lower in production use
                    dataProviders: [
                        {
                            name: 'optable',
                            waitForIt: true,
                            params: {
                                // REQUIRED PARAMETERS:
                                host: 'na.edge.optable.co',      // Your DCN hostname
                                site: 'prebidtest-sdk',             // Your site identifier
                                node: 'prebidtest',                 // Your node identifier

                                // OPTIONAL PARAMETERS:
                                cookies: false,                   // Cookie mode (default: true, set to false for cookieless)
                                // timeout: '500ms',             // API timeout hint
                                ids: ['i4:1.2.3.4'],          // User identifiers (also auto-extracted from Prebid userId module)
                                // hids: ['hid1'],               // Household identifiers

                                // CUSTOM HANDLER (optional):
                                // handleRtd: (reqBidsConfigObj, targetingData, mergeFn) => {
                                //     console.log('Custom RTD handler');
                                //     console.log('Targeting data:', targetingData);
                                //     // Perform custom logic here
                                //     mergeFn(reqBidsConfigObj.ortb2Fragments.global, targetingData.ortb2);
                                // }
                            }
                        }
                    ]
                },
            });

            pbjs.addAdUnits(adUnits);

            // Track if we've already displayed the data (only show once)
            let displayedEnrichedData = false;

            pbjs.onEvent('bidRequested', function (data) {
                try {
                    // Display the enriched user data from Optable RTD
                    if (!displayedEnrichedData && data.ortb2 && data.ortb2.user) {
                        console.log('Full bid request ortb2:', data.ortb2);
                        console.log('User data:', data.ortb2.user);

                        const userData = data.ortb2.user;
                        const eidCount = userData.eids ? userData.eids.length : 0;
                        const dataCount = userData.data ? userData.data.length : 0;

                        console.log(`Found ${eidCount} EIDs and ${dataCount} data segments`);

                        document.getElementById('enriched-optable').style.display = 'block';
                        document.getElementById('enriched-optable-data').textContent = JSON.stringify(userData, null, 2);
                        displayedEnrichedData = true;
                    }
                } catch (e) {
                    console.error('Exception while trying to display enriched data', e);
                }
            });

            pbjs.requestBids({
                timeout: PREBID_TIMEOUT,
                bidsBackHandler: function (bidResponses) {
                    initAdserver();
                }
            });
        });
        setTimeout(initAdserver, FAILSAFE_TIMEOUT);
    </script>

    <script>
        googletag.cmd.push(function () {
            googletag
                .defineSlot(
                    '/22081946781/web-sdk-demo-gam360/header-ad',
                    [[728, 90]],
                    'div-gpt-ad-1598295788551-0'
                )
                .addService(googletag.pubads());

            googletag
                .defineSlot(
                    '/22081946781/web-sdk-demo-gam360/box-ad',
                    [[250, 250], [300, 250], [200, 200]],
                    'div-gpt-ad-1598295897480-0'
                )
                .addService(googletag.pubads());

            googletag
                .defineSlot(
                    '/22081946781/web-sdk-demo-gam360/footer-ad',
                    [[728, 90]],
                    'div-gpt-ad-1598296001655-0'
                )
                .addService(googletag.pubads());

            googletag.pubads().disableInitialLoad();
            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
</head>
<body>
    <main class="container">
        <div class="row">
            <img
                src="https://demo.optable.co/images/logo.png"
                width="200"
                alt="optable"
                style="margin-top: 48px"/>
            <hr class="delim" />
        </div>
        <div class="row">
            <h1>Optable RTD module example</h1>
        </div>

        <h3>web-sdk-demo-gam360/header-ad</h3>
        <div id="div-gpt-ad-1598295788551-0">
            <p>No response</p>
            <script type="text/javascript">
                googletag.cmd.push(function () {
                    googletag.display('div-gpt-ad-1598295788551-0');
                });
            </script>
        </div>

        <h3>web-sdk-demo-gam360/box-ad</h3>
        <div id="div-gpt-ad-1598295897480-0">
            <p>No response</p>
            <script type="text/javascript">
                googletag.cmd.push(function () {
                    googletag.display('div-gpt-ad-1598295897480-0');
                });
            </script>
        </div>

        <h3>web-sdk-demo-gam360/footer-ad</h3>
        <div id="div-gpt-ad-1598296001655-0">
            <p>No response</p>
            <script type="text/javascript">
                googletag.cmd.push(function () {
                    googletag.display('div-gpt-ad-1598296001655-0');
                });
            </script>
        </div>

        <div id="enriched-optable" style="display: none;">
            <h3>Enriched ortb2.user data from Optable RTD module</h3>
            <pre id="enriched-optable-data"></pre>
        </div>
    </main>
</body>
</html>
