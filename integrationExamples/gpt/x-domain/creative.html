<!-- This script tag should be returned by your ad server -->

<script>
    // This is the `renderAd` function from Prebid.js moved within the creative iframe
  var renderAd = function (ev) {
      console.log('renderAd ev: ', ev);
    var key = ev.message ? "message" : "data";
    var adObject = {};
    try {
      adObject = JSON.parse(ev[key]);
    } catch (e) {
      console.log('Do nothing.  No ad found.');
      return;
    }
    console.log('what is adObject? ', adObject);
    pbjs._winningBids.push(adObject);
    //emit 'bid won' event here
//    events.emit(BID_WON, adObject);

    var height = adObject.height;
    var width = adObject.width;
    var url = adObject.adUrl;
    var ad = adObject.ad;
    var doc = adObject.source && adObject.source.document;

    if (doc===document || adObject.mediaType === 'video') {
        utils.logError('Error trying to write ad. Ad render call ad id ' + id + ' was prevented from writing to the main document.');
    } else if (ad) {
      doc.write(ad);
      doc.close();
      setRenderSize(doc, width, height);
    } else if (url) {
      doc.write('<IFRAME SRC="' + url + '" FRAMEBORDER="0" SCROLLING="no" MARGINHEIGHT="0" MARGINWIDTH="0" TOPMARGIN="0" LEFTMARGIN="0" ALLOWTRANSPARENCY="true" WIDTH="' + width + '" HEIGHT="' + height + '"></IFRAME>');
      doc.close();
      setRenderSize(doc, width, height);
    } else {
      utils.logError('Error trying to write ad. No ad for bid response id: ' + id);
    }
  };

  function requestAdFromPrebid () {
    var message = JSON.stringify({
      message: 'Prebid Request',
      adId: '%%PATTERN:hb_adid%%'
    });
    window.parent.postMessage(message, '*');
  }

  function listenAdFromPrebid () {
    window.addEventListener("message", renderAd, false);
  }

  function setRenderSize(doc, width, height) {
     if (doc.defaultView && doc.defaultView.frameElement) {
        doc.defaultView.frameElement.width = width;
        doc.defaultView.frameElement.height = height;
     }
  }

  function sendEventToPrebid(adObject) {
      var message = JSON.stringify({
          message: 'Prebid Event',
          adObject
      });
      window.parent.postMessage(message, '*');
  }
  listenAdFromPrebid();
  requestAdFromPrebid();
</script>
