<!DOCTYPE html>
<html lang="en">

<head>
    <title>Measure lift of ID Example</title>
    <script>
        const FAILSAFE_TIMEOUT = 2000;
        const adUnits = [
            {
                code: 'test-div',
                mediaTypes: {
                    banner: {
                        sizes: [[300, 250], [300, 600], [728, 90]]
                    },
                },
                bids: [
                    {
                        bidder: 'rubicon',
                        params: {
                            accountId: '1001',
                            siteId: '113932',
                            zoneId: '535510'
                        }
                    }
                ]
            }
        ];
        var pbjs = pbjs || {};
        pbjs.que = pbjs.que || [];
    </script>
    <script src="../../build/dev/prebid.js" async></script>

    <script>
        const IDMOD_REPORTING_KEY = "id_mod1";
        const TREATMENT_RATE = 0.95;
        window.idModuleEnabled = Math.random() < TREATMENT_RATE;
        var googletag = googletag || {};
        googletag.cmd = googletag.cmd || [];
        googletag.cmd.push(function () {
            googletag.pubads().disableInitialLoad();
            let targeting = window.idModuleEnabled ? "t1" : "t0";
            googletag.pubads().setTargeting(IDMOD_REPORTING_KEY, targeting);
        });
      
        pbjs.que.push(function () {
            pbjs.setConfig({ debug: true });
            pbjs.addAdUnits(adUnits);
            pbjs.requestBids({
                bidsBackHandler: sendAdserverRequest
            });
            if (window.idModuleEnabled) {
              pbjs.mergeConfig({
                userSync: {
                    userIds: [
                        {
                            name: 'rewardedInterestId',
                        },
                    ],
                    syncDelay: 5000,
                    auctionDelay: 1000,
                }
            });
        });

        function sendAdserverRequest() {
            if (pbjs.adserverRequestSent) return;
            pbjs.adserverRequestSent = true;
            googletag.cmd.push(function () {
                pbjs.que.push(function () {
                    pbjs.setTargetingForGPTAsync();
                    googletag.pubads().refresh();
                });
            });
        }

        setTimeout(function () {
            sendAdserverRequest();
        }, FAILSAFE_TIMEOUT);
    </script>

    <script>
        (function () {
            var gads = document.createElement('script');
            gads.async = true;
            gads.type = 'text/javascript';
            gads.src = 'https://securepubads.g.doubleclick.net/tag/js/gpt.js';
            var node = document.getElementsByTagName('script')[0];
            node.parentNode.insertBefore(gads, node);
        })();
    </script>

    <script>
        googletag.cmd.push(function () {
            googletag.defineSlot('/112115922/FL_PB_MedRect', [[300, 250], [300, 600], [728, 90]], 'test-div').addService(googletag.pubads());
            googletag.pubads().enableSingleRequest();
            googletag.enableServices();
        });
    </script>
</head>

<body>
<script>
    pbjs.que.push(function () {
        pbjs.getUserIdsAsync().then(ids => {
            document.getElementById('ids-div').innerHTML = JSON.stringify(ids, null, ' ');
            document.getElementById('eids-div').innerHTML = JSON.stringify(pbjs.getUserIdsAsEids(), null, ' ');
        });
    });
</script>

<h2>Rewarded Interest ID Example</h2>

<h4>Generated IDs:</h4>
<pre id="ids-div" style="border:1px solid #333; padding:5px; overflow: auto"></pre>

<h4>Generated EIDs</h4>
<pre id="eids-div" style="border:1px solid #333; padding:5px; overflow: auto"></pre>
  <!-- Instructions Section -->
    <h3>Instructions</h3>
    <ol>
        <li>Ensure that the `IDMOD_REPORTING_KEY` is defined in the code as a key to measure the performance.</li>
        <li>In Google Ad Manager (GAM), create a report with the following setup:
            <ul>
                <li>Dimensions: Ad Unit, Key-Value Targeting (e.g., the IDMOD_REPORTING_KEY).</li>
                <li>Metrics: Impressions, Clicks, Revenue.</li>
                <li>Filters: Ensure that targeting for <code>id_mod1</code> is included in the report.</li>
            </ul>
        </li>
        <li>Analyze the report:
            <ul>
                <li>Compare performance for `t1` (treatment group) versus `t0` (control group) values of the key.</li>
                <li>Calculate lift using the formula: 
                    <pre>Lift (%) = ((Treatment Metric - Control Metric) / Control Metric) * 100</pre>
                    Replace "Metric" with Impressions, Clicks, or Revenue as needed.
                </li>
            </ul>
        </li>
    </ol>
</body>

</html>
